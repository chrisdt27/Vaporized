<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Vaporized — Intro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#000; --fg:#fff; --muted:#bbb;
    --accent:#23c2ff; --warn:#6a2c2c; --card:#111; --border:#333;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial}

  /* Stage */
  #stage{position:fixed;inset:0;display:grid;place-items:center}
  video{max-width:100vw;max-height:100vh;object-fit:cover;background:#000}

  /* Start gate overlay with a simple white play button */
  #gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.75)}
  #gateBtn{
    width:96px;height:96px;border-radius:50%;border:none;background:#fff;cursor:pointer;position:relative;
    box-shadow:0 8px 24px rgba(0,0,0,.45);
  }
  #gateBtn::after{
    content:""; position:absolute; left:40px; top:30px;
    border-left:24px solid #000; border-top:14px solid transparent; border-bottom:14px solid transparent;
    width:0;height:0;
  }
  /* visually-hidden label for accessibility */
  #gateBtn span{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}

  /* Fade overlay */
  #fade{pointer-events:none;position:fixed;inset:0;background:#000;opacity:0;transition:opacity .6s}
  #fade.show{opacity:1}

  /* Choice screen — minimal copy */
  #choice{position:fixed;inset:0;display:none;align-items:center;justify-content:center;gap:24px;background:rgba(0,0,0,.80);padding:20px}
  .card{min-width:280px;max-width:420px;border-radius:14px;padding:18px 20px;background:var(--card);border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .card h2{margin:0 0 .6em 0;font-size:26px}
  .btn{display:inline-block;padding:12px 18px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--accent);color:#002}
  .btn-warn{background:var(--warn);color:#fff}

  /* Error bar */
  #err{position:fixed;left:0;right:0;bottom:0;background:rgba(200,0,0,.75);padding:6px 10px;font-size:12px;display:none;white-space:pre-wrap}

  /* Continue button for Classroom transition */
  #continueBtn {
    position: fixed;
    bottom: 40px;
    right: 40px;
    padding: 15px 30px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    display: none;
    z-index: 1000;
  }
</style>
</head>
<body>
  <div id="stage">
    <!-- Start muted; we unmute after the user's tap -->
    <video id="vid" playsinline preload="auto" muted></video>
  </div>

  <!-- Start gate (guarantees audio) -->
  <div id="gate">
    <button id="gateBtn" aria-label="Play"><span>Play</span></button>
  </div>

  <!-- Choice UI (minimal text) -->
  <div id="choice">
    <div class="card">
      <h2>Take a Puff</h2>
      <button id="btnVR" class="btn btn-primary">Enter Body Journey</button>
    </div>
    <div class="card">
      <h2>No, Thanks</h2>
      <button id="btnNo" class="btn btn-warn">Skip to Reward</button>
    </div>
  </div>

  <!-- Continue to Classroom Button -->
  <button id="continueBtn" onclick="goToClassroom()">Continue to Classroom</button>

  <div id="fade"></div>
  <div id="err"></div>

<script>
  // -------- Paths (change only if your filenames differ) ----------
  const INTRO      = 'assets/00_intro_1080p24.mp4';
  const PARKING    = 'assets/01_parking_offer_1080p24.mp4';
  const TO_VR      = 'journeys/mouth_final.html'; // UPDATED: Points to mouth_final.html
  const TO_REWARD  = 'assets/reward_scene.html';  // at root
  const TO_CLASSROOM = '../vape_on_the_brain_vr/Classroom/classroom_scene.html'; // ADDED: Path to classroom

  // -------- DOM ----------
  const vid     = document.getElementById('vid');
  const gate    = document.getElementById('gate');
  const gateBtn = document.getElementById('gateBtn');
  const choice  = document.getElementById('choice');
  const fadeEl  = document.getElementById('fade');
  const errEl   = document.getElementById('err');
  const btnVR   = document.getElementById('btnVR');
  const btnNo   = document.getElementById('btnNo');
  const continueBtn = document.getElementById('continueBtn'); // ADDED

  // -------- Utils ----------
  function showError(msg){ console.error(msg); errEl.textContent = msg; errEl.style.display='block'; }
  function fadeAndGo(url){ try{ fadeEl.classList.add('show'); setTimeout(()=>location.href=url, 600); }catch{ location.href=url; } }
  function showChoice(){ choice.style.display='flex'; btnVR?.focus(); }

  // ADDED: Function to go to classroom
  function goToClassroom() {
    fadeAndGo(TO_CLASSROOM);
  }

  // ADDED: Show continue button after body journey completes
  function showContinueButton() {
    continueBtn.style.display = 'block';
  }

  // Play a src and resolve when it ends; guard timer for bad metadata
  function playUntilEnd(src){
    return new Promise((resolve, reject)=>{
      let guard=null, ended=false;

      vid.src = src;
      vid.loop = false;
      vid.onerror = ()=>reject(new Error('Video failed to load: ' + src));

      const start = ()=>{
        const dur = Number.isFinite(vid.duration) && vid.duration>0 ? vid.duration : 75;
        guard = setTimeout(()=>{ if(!ended){ cleanup(); resolve(); } }, (dur+2)*1000);

        vid.play()
          .then(()=>{ vid.onended = ()=>{ ended=true; cleanup(); resolve(); }; })
          .catch(err=>{ cleanup(); reject(err); });
      };

      const cleanup = ()=>{ clearTimeout(guard); vid.onended=null; vid.oncanplay=null; vid.onloadedmetadata=null; };
      vid.onloadedmetadata = start;
      vid.oncanplay = start;
      vid.load();
    });
  }

  async function startSequenceWithAudio(){
    vid.muted = false;                 // enable audio after user gesture
    await playUntilEnd(INTRO);
    await playUntilEnd(PARKING);
    showChoice();
  }

  // Require one user gesture so audio is guaranteed
  gateBtn.addEventListener('click', async ()=>{
    gate.style.display = 'none';
    try {
      await startSequenceWithAudio();
    } catch(e){
      showError(e.message || String(e));
      showChoice();
    }
  });

  // Choice actions + keyboard shortcuts
  btnVR.addEventListener('click',  ()=> {
    fadeAndGo(TO_VR);
    // ADDED: Set a timeout to show continue button after body journey
    setTimeout(showContinueButton, 45000); // Show after 45 seconds
  });
  
  btnNo.addEventListener('click',  ()=> goReward());

  window.addEventListener('keydown', (e)=>{
    if(e.key==='1') {
      fadeAndGo(TO_VR);
      setTimeout(showContinueButton, 45000); // Show after 45 seconds
    }
    if(e.key==='2') goReward();
    if(e.key==='3') goToClassroom(); // ADDED: Quick access to classroom
  });

  // Reward navigation with a defensive fallback
  function goReward(){
    // Primary path - goes to reward scene where user can choose to start body journey
    try { location.href = TO_REWARD; }
    catch { location.href = 'reward_scene.html'; } // fallback if a relative quirk appears
  }

  // ADDED: Auto-detect if we're returning from body journey and show continue button
  window.addEventListener('pageshow', function(event) {
    // If we're returning to this page from the body journey, show continue button
    if (sessionStorage.getItem('bodyJourneyCompleted')) {
      showContinueButton();
      sessionStorage.removeItem('bodyJourneyCompleted');
    }
  });
</script>
</body>
</html>