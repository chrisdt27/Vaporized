<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mouth – QUEST READY (Autoplay + Learn More + REL paths)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1, maximum-scale=1"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html, body { margin:0; height:100%; background:#000; }
    #err{ position:fixed; left:0; right:0; bottom:0; color:#fff; background:rgba(200,0,0,.25);
          font:12px/1.4 monospace; padding:6px 8px; display:none; white-space:pre-wrap; pointer-events:none; z-index:99999; }
    #hint{ position:fixed; right:10px; top:8px; color:#5ac8ff; font:11px/1.4 monospace; opacity:.70; pointer-events:none; z-index:2; }

    /* White textbox styling for Learn More popups */
    .callout {
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(520px, 88vw); max-height: 70vh; overflow: auto;
      background: #fff; color: #111; border: 2px solid #000; border-radius: 10px;
      box-shadow: 0 8px 28px rgba(0,0,0,.5);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 14px 16px; display: none; z-index: 9999;
    }
    .callout h3{ margin: 0 0 6px 0; font-size: 17px; color: #000; }
    .callout button{ margin-top: 10px; background: #111; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; }

    /* Continue button overlay (flat HTML for reliability) */
    #continueBtn {
      position: fixed; right: 14px; bottom: 14px; z-index: 3;
      background: #0ea5e9; color: #001018; border: 2px solid #001018; border-radius: 12px;
      padding: 10px 14px; font-weight: 700; cursor: pointer; user-select: none;
    }
    #continueBtn:hover{ filter: brightness(1.05); }
  </style>
</head>
<body>
<a-scene
  background="color:#000000"
  renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true;"
  xr-mode-ui="enabled: true"
  vr-mode-ui="enterVRButton: true"
  cursor="rayOrigin: mouse"
  raycaster="objects: .clickable">

  <!-- Assets (REL paths) -->
  <a-assets timeout="20000">
    <audio id="mouthNarration" src="assets/audio/mouth_narration.mp3" preload="auto" crossorigin="anonymous"></audio>
  </a-assets>

  <!-- Lights -->
  <a-entity light="type: ambient; intensity: 0.6"></a-entity>
  <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>

  <!-- Camera rig with VR + Desktop cursors -->
  <a-entity id="rig" position="0 0 0">
    <a-entity id="cam"
              camera="near:0.001; far:1000; fov:80"
              look-controls="pointerLockEnabled:false"
              position="0 0 0.15">
      <!-- Desktop mouse ray -->
      <a-entity id="mouseRay" cursor="rayOrigin: mouse"
                raycaster="objects: .clickable; far: 10; interval: 0"></a-entity>
      <!-- VR gaze/controller cursor -->
      <a-entity id="vrCursor"
                position="0 0 -0.5"
                geometry="primitive: ring; radiusInner:0.005; radiusOuter:0.008"
                material="color:#5ac8ff; shader: flat; opacity:0.85"
                cursor="fuse: false; rayOrigin: entity;"
                raycaster="objects: .clickable; far: 10">
      </a-entity>
    </a-entity>
  </a-entity>

  <!-- Mouth model -->
  <a-entity id="mouth" gltf-model="assets/models/mouth.glb"></a-entity>

  <!-- Droplet emitter -->
  <a-entity id="aeroEmitter"></a-entity>

  <!-- Learn More Hotspots (red dots) -->
  <a-entity id="hotspots" visible="true">
    <!-- Each hotspot: a visible red disc + invisible larger click target -->
    <a-entity id="hs-teeth" position="0.08 0.02 -0.35">
      <a-circle radius="0.018" color="#c40000" position="0 0 0" rotation="-90 0 0"></a-circle>
      <a-entity text="value: Learn More; color: #fff; align: center; width: 0.6" position="0 0.002 0" rotation="-90 0 0"></a-entity>
      <a-sphere class="clickable" radius="0.05" position="0 0 0" material="color:#fff; opacity:0; transparent:true"></a-sphere>
    </a-entity>

    <a-entity id="hs-tongue" position="-0.05 -0.02 -0.38">
      <a-circle radius="0.018" color="#c40000" position="0 0 0" rotation="-90 0 0"></a-circle>
      <a-entity text="value: Learn More; color: #fff; align: center; width: 0.6" position="0 0.002 0" rotation="-90 0 0"></a-entity>
      <a-sphere class="clickable" radius="0.05" position="0 0 0" material="color:#fff; opacity:0; transparent:true"></a-sphere>
    </a-entity>

    <a-entity id="hs-cheek" position="0.00 0.04 -0.28">
      <a-circle radius="0.018" color="#c40000" position="0 0 0" rotation="-90 0 0"></a-circle>
      <a-entity text="value: Learn More; color: #fff; align: center; width: 0.6" position="0 0.002 0" rotation="-90 0 0"></a-entity>
      <a-sphere class="clickable" radius="0.05" position="0 0 0" material="color:#fff; opacity:0; transparent:true"></a-sphere>
    </a-entity>
  </a-entity>

  <!-- Narration like bronchi (entity sound) -->
  <a-entity id="narration" sound="src: #mouthNarration; autoplay: true; positional: false; volume: 1.0;"></a-entity>
</a-scene>

<!-- Competition-proof UI elements -->
<div id="err"></div>
<div id="hint">Click/gaze red dots • L = toggle dots • [ / ] = droplet rate -/+ • D = toggle droplets</div>
<div id="continueBtn">Continue → Bronchi</div>

<!-- White callouts (black text, black border) -->
<div id="callout-teeth" class="callout">
  <h3>Teeth & Enamel Film</h3>
  <p>Warm aerosol forms a hygroscopic film (propylene glycol + glycerin) on teeth. It captures nicotine, flavor chemicals, and micro-metals from the coil, increasing plaque adhesion and enamel exposure to acids.</p>
  <button data-close="callout-teeth">Close</button>
</div>

<div id="callout-tongue" class="callout">
  <h3>Tongue & Taste Receptors</h3>
  <p>Deposited droplets temporarily blunt taste receptors and dehydrate the tongue surface, degrading taste acuity and mouthfeel while concentrating irritants.</p>
  <button data-close="callout-tongue">Close</button>
</div>

<div id="callout-cheek" class="callout">
  <h3>Cheek/Labial Mucosa</h3>
  <p>Sticky aerosol residues coat the lining and increase contact time for aldehydes (e.g., formaldehyde, acetaldehyde, acrolein), aggravating local irritation and dryness.</p>
  <button data-close="callout-cheek">Close</button>
</div>

<script>
  function showError(msg){
    try{
      console.error(msg);
      const el=document.getElementById('err');
      el.textContent=String(msg);
      el.style.display='block';
    }catch(_){}
  }

  // Robust narration start: desktop + Quest (enter-vr)
  (function(){
    const sEl = document.getElementById('narration');
    const scene = document.querySelector('a-scene');
    scene.addEventListener('loaded', ()=>{
      const c = sEl.components.sound;
      if(c && c.playing===false){ try{ c.playSound(); }catch(_){ } }
    });
    scene.addEventListener('enter-vr', ()=>{
      const c = sEl.components.sound;
      if(c && c.playing===false){ try{ c.playSound(); }catch(_){ } }
    });
  })();

  // Initialize droplets (performance tuned, like bronchi)
  AFRAME.registerComponent('droplet-field',{
    schema:{
      enabled:{default:true}, rate:{default:260}, life:{default:3200},
      sizeStart:{default:0.006}, sizeEnd:{default:0.014},
      speed:{default:0.50}, speedJitter:{default:0.25},
      lateral:{default:0.05}, sheetDist:{default:0.18}, sheetWidth:{default:0.22},
      sheetHeight:{default:0.18}, sheetDepth:{default:0.14},
      swirl:{default:0.10}, swirlHz:{default:1.1}, drag:{default:0.38}, max:{default:720}
    },
    init:function(){
      try{ if(AFRAME.utils.device.isMobile()){ this.data.rate=190; this.data.max=520; this.data.life=2800; } }catch(_){}
      this.pool=[]; this.acc=0;
      const tex=(function(){const R=64,c=document.createElement('canvas'); c.width=c.height=R*2; const g=c.getContext('2d');
        const gr=g.createRadialGradient(R,R,0,R,R,R); gr.addColorStop(0,'rgba(255,255,255,1)');
        gr.addColorStop(.45,'rgba(255,255,255,.7)'); gr.addColorStop(.8,'rgba(255,255,255,.12)'); gr.addColorStop(1,'rgba(255,255,255,0)');
        g.fillStyle=gr; g.fillRect(0,0,c.width,c.height); const t=new THREE.CanvasTexture(c); t.anisotropy=4; t.needsUpdate=true; return t; })();
      for(let i=0;i<this.data.max;i++){
        const mat=new THREE.SpriteMaterial({map:tex, color:0xffffff, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, opacity:0});
        const s=new THREE.Sprite(mat); s.visible=false; s.scale.setScalar(this.data.sizeStart);
        this.el.object3D.add(s);
        this.pool.push({obj:s, mat:mat, alive:false, t:0, vel:new THREE.Vector3(), phase:Math.random()*Math.PI*2});
      }
      window.addEventListener('keydown',(e)=>{
        if(e.key==='d'||e.key==='D') this.data.enabled=!this.data.enabled;
        if(e.key==='[') this.data.rate=Math.max(40,this.data.rate-25);
        if(e.key===']') this.data.rate=Math.min(1500,this.data.rate+25);
      });
      this.tmp={pos:new THREE.Vector3(), f:new THREE.Vector3(), r:new THREE.Vector3(), u:new THREE.Vector3()};
    },
    _basis:function(out){
      const cam=document.getElementById('cam'); if(!cam) return null;
      const m=cam.object3D.matrixWorld;
      out.f.set(-m.elements[8],-m.elements[9],-m.elements[10]).normalize();
      out.r.set(m.elements[0],m.elements[1],m.elements[2]).normalize();
      out.u.set(m.elements[4],m.elements[5],m.elements[6]).normalize();
      out.pos.set(m.elements[12],m.elements[13],m.elements[14]); return out;
    },
    _spawn:function(){
      const d=this.data, b=this.tmp; if(!this._basis(b)) return;
      const slot=this.pool.find(p=>!p.alive); if(!slot) return;
      slot.alive=true; slot.t=0;
      const hw=d.sheetWidth*.5, hh=d.sheetHeight*.5, hd=d.sheetDepth*.5;
      const ox=(Math.random()*2-1)*hw, oy=(Math.random()*2-1)*hh, oz=-d.sheetDist+(Math.random()*2-1)*hd;
      const spawn=new THREE.Vector3().copy(b.pos).addScaledVector(b.f,oz).addScaledVector(b.r,ox).addScaledVector(b.u,oy);
      slot.obj.position.copy(spawn); slot.obj.visible=true; slot.obj.scale.setScalar(d.sizeStart); slot.mat.opacity=.9;
      slot.vel=new THREE.Vector3().copy(b.f).multiplyScalar(d.speed*(.9+.3*Math.random()));
      slot.vel.addScaledVector(b.r,(Math.random()*2-1)*d.lateral); slot.vel.addScaledVector(b.u,(Math.random()*2-1)*d.lateral);
      slot.phase=Math.random()*Math.PI*2;
    },
    tick:function(time,dt){
      if(!dt) return; const d=this.data;
      if(d.enabled){ this.acc+=dt; const interval=1000/Math.max(1e-4,d.rate); while(this.acc>=interval){ this._spawn(); this.acc-=interval; } }
      const drag=(1-d.drag);
      for(const p of this.pool){ if(!p.alive) continue; p.t+=dt;
        const k=Math.min(1,p.t/d.life); const s=d.sizeStart*(1-k)+d.sizeEnd*k; p.obj.scale.set(s,s,1);
        const swirlX=Math.sin((time*.001+p.phase)*Math.PI*2*d.swirlHz)*d.swirl;
        const swirlY=Math.cos((time*.0009+p.phase*1.37)*Math.PI*2*d.swirlHz)*d.swirl;
        p.vel.x+=swirlX*(dt/1000); p.vel.y+=swirlY*(dt/1000); p.vel.multiplyScalar(Math.pow(drag,dt/1000));
        p.obj.position.addScaledVector(p.vel,dt/1000); p.mat.opacity=.9*(1-k);
        if(k>=1){ p.alive=false; p.obj.visible=false; }
      }
    }
  });
  document.getElementById('aeroEmitter').setAttribute('droplet-field','');

  // Learn More popups (white textboxes)
  (function(){
    const map = {
      'hs-teeth': 'callout-teeth',
      'hs-tongue': 'callout-tongue',
      'hs-cheek': 'callout-cheek'
    };
    Object.keys(map).forEach(id => {
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', ()=>{
        const box = document.getElementById(map[id]);
        if(box){ box.style.display = 'block'; }
      });
    });
    document.querySelectorAll('.callout button').forEach(btn => {
      btn.addEventListener('click', ()=>{
        const t = btn.getAttribute('data-close');
        const box = document.getElementById(t);
        if(box) box.style.display = 'none';
      });
    });
    // Toggle hotspots with L (if needed)
    window.addEventListener('keydown', (e)=>{
      if(e.key==='l' || e.key==='L'){
        const g=document.getElementById('hotspots');
        g.setAttribute('visible', !(g.getAttribute('visible')));
      }
    });
  })();

  // Continue → Bronchi (no fade)
  document.getElementById('continueBtn').addEventListener('click', ()=>{
    window.location.href = 'bronchi_inside_min_QUEST.html';
  });
</script>
</body>
</html>
