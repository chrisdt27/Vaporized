<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bronchi – Inside Tube POV (Oral → Lungs)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1, maximum-scale=1"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html, body { margin:0; height:100%; background:#000; }
    #hud{ position:fixed; left:10px; top:8px; color:#9ad7ff; font:11px/1.4 monospace; opacity:.9; pointer-events:none; z-index:3; }
    #err{ position:fixed; left:0; right:0; bottom:0; color:#fff; background:rgba(200,0,0,.28);
          font:12px/1.5 monospace; padding:6px 8px; display:none; white-space:pre-wrap; z-index:4; }
    .callout { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(520px, 88vw); max-height: 70vh; overflow: auto; background: #fff; color: #111;
      border: 2px solid #000; border-radius: 10px; box-shadow: 0 8px 28px rgba(0,0,0,.5);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 12px 14px; display: none; z-index: 5; }
    #continueBtn { position: fixed; right: 14px; bottom: 14px; z-index: 3; background: #0ea5e9; color: #001018;
      border: 2px solid #001018; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer; user-select: none; }
  </style>
</head>
<body>
<a-scene background="color:#050505" renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true;"
         xr-mode-ui="enabled:true" vr-mode-ui="enterVRButton:true" cursor="rayOrigin: mouse" raycaster="objects: .clickable">

  <a-assets timeout="20000">
    <audio id="bronchiNarration" src="../assets/audio/bronchi_narration.mp3" preload="auto" crossorigin="anonymous"></audio>
  </a-assets>

  <!-- Lighting -->
  <a-entity light="type: ambient; intensity:0.9; color:#ffffff"></a-entity>
  <a-entity light="type: directional; intensity:1.0; color:#ffffff" position="1.5 2.2 1.2"></a-entity>
  <a-entity light="type: directional; intensity:0.6; color:#ffffff" position="-1.3 -0.8 -0.6"></a-entity>

  <!-- Camera rig -->
  <a-entity id="rig" position="0 0 0">
    <a-entity id="cam" camera="near:0.001; far:2000; fov:80"
              look-controls="pointerLockEnabled:false; touchEnabled:true; mouseEnabled:true"
              position="0 0 0.1"></a-entity>
  </a-entity>

  <!-- Fallback cylinder ensures camera always inside -->
  <a-cylinder id="tube" radius="0.18" height="2" open-ended="true"
              rotation="90 0 0" position="0 0 -0.4"
              material="color:#9b6060; metalness:0; roughness:1; side:back; opacity:0.5">
  </a-cylinder>

  <!-- Bronchi model -->
  <a-entity id="bronchiModel"></a-entity>

  <!-- Arrow -->
  <a-entity id="arrow" position="0 0 -0.15">
    <a-cylinder radius="0.004" height="0.08" color="#2dd4bf" position="0 0 -0.04" rotation="90 0 0"></a-cylinder>
    <a-cone radius-bottom="0.018" radius-top="0.0" height="0.04" color="#2dd4bf" position="0 0 -0.08" rotation="90 0 0"></a-cone>
    <a-entity text="value: Toward lungs; color:#fff; align:center; width:0.7" position="0 0 -0.11"></a-entity>
  </a-entity>

  <!-- Droplets -->
  <a-entity id="aeroEmitter"></a-entity>

  <!-- Hotspots -->
  <a-entity id="hs-cilia"></a-entity>
  <a-entity id="hs-mucus"></a-entity>
  <a-entity id="hs-branch"></a-entity>

  <!-- Narration -->
  <a-entity id="narration" sound="src:#bronchiNarration; autoplay:true; positional:false; volume:1.0;"></a-entity>
</a-scene>

<div id="hud">N: replay narration • L: toggle hotspots • [ / ]: droplet rate -/+ • D: toggle droplets</div>
<div id="err"></div>
<div id="continueBtn">Continue → Lungs</div>

<!-- Callouts -->
<div id="callout-cilia" class="callout"><h3>Cilia Escalator</h3>
  <p>Tiny cilia beat upward to move mucus and trapped particles out. Vape droplets burden this system.</p>
  <button data-close="callout-cilia">Close</button></div>
<div id="callout-mucus" class="callout"><h3>Mucus Layer</h3>
  <p>Vape aerosol draws water, thickening mucus and altering viscosity, slowing clearance.</p>
  <button data-close="callout-mucus">Close</button></div>
<div id="callout-branch" class="callout"><h3>Branching Geometry</h3>
  <p>Droplets impact at airway splits, increasing local exposure on carina ridges.</p>
  <button data-close="callout-branch">Close</button></div>

<script>
(function(){
  const model=document.getElementById('bronchiModel');
  model.setAttribute('gltf-model','../assets/models/bronchi.glb');
  model.addEventListener('model-error',()=>console.error('Failed to load bronchi.glb'));
  model.addEventListener('model-loaded',()=>{
    const mesh=model.getObject3D('mesh');
    if(mesh){
      mesh.traverse(n=>{
        if(n.isMesh){
          const mats=Array.isArray(n.material)?n.material:[n.material];
          mats.forEach(m=>{ if(m){ m.side=THREE.DoubleSide; m.needsUpdate=true; }});
        }
      });
      const box=new THREE.Box3().setFromObject(mesh);
      const size=box.getSize(new THREE.Vector3());
      const center=box.getCenter(new THREE.Vector3());
      mesh.position.sub(center);
      const s=0.6/Math.min(size.x,size.y,size.z);
      mesh.scale.setScalar(s);
      model.object3D.position.set(0,0,-0.6);

      const cam=document.getElementById('cam');
      cam.object3D.position.set(0,0,0.1);
      cam.object3D.lookAt(new THREE.Vector3(0,0,-1));
    }
  });
})();

// Hotspots
AFRAME.registerComponent('face-camera',{
  tick:function(){
    const cam=document.getElementById('cam');
    if(cam && this.el.object3D)
      this.el.object3D.lookAt(cam.object3D.getWorldPosition(new THREE.Vector3()));
  }
});
function addHotspot(id,pos,callout){
  const el=document.getElementById(id); if(!el) return;
  const disc=document.createElement('a-circle');
  disc.setAttribute('radius','0.014');
  disc.setAttribute('color','#d40000');
  disc.setAttribute('material','shader:flat;opacity:0.98');
  disc.setAttribute('animation__pulse','property:scale;dir:alternate;dur:700;loop:true;to:1.25 1.25 1.25');
  disc.setAttribute('face-camera','');
  const label=document.createElement('a-entity');
  label.setAttribute('text','value: Learn More; color:#fff; align:center; width:0.5');
  label.setAttribute('position','0 0 0.001');
  label.setAttribute('face-camera','');
  const hit=document.createElement('a-sphere');
  hit.setAttribute('radius','0.055');
  hit.setAttribute('material','color:#fff;opacity:0;transparent:true');
  hit.classList.add('clickable');
  el.append(disc,label,hit);
  el.setAttribute('position',pos);
  el.addEventListener('click',()=>{document.getElementById(callout).style.display='block';});
}
addHotspot('hs-cilia','0.06 0.02 -0.22','callout-cilia');
addHotspot('hs-mucus','-0.08 -0.01 -0.3','callout-mucus');
addHotspot('hs-branch','0 -0.04 -0.4','callout-branch');
document.querySelectorAll('.callout button').forEach(b=>b.onclick=()=>{document.getElementById(b.dataset.close).style.display='none';});

// Droplets
AFRAME.registerComponent('droplet-field',{
  schema:{rate:{default:220},max:{default:620}},
  init:function(){
    const tex=(function(){const R=64,c=document.createElement('canvas');c.width=c.height=R*2;
      const g=c.getContext('2d');const gr=g.createRadialGradient(R,R,0,R,R,R);
      gr.addColorStop(0,'rgba(255,255,255,1)');gr.addColorStop(1,'rgba(255,255,255,0)');
      g.fillStyle=gr;g.fillRect(0,0,c.width,c.height);
      const t=new THREE.CanvasTexture(c);t.needsUpdate=true;return t;})();
    this.pool=[];
    for(let i=0;i<this.data.max;i++){
      const mat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:0});
      const s=new THREE.Sprite(mat);
      s.visible=false;
      this.el.object3D.add(s);
      this.pool.push({obj:s,alive:false,t:0});
    }
  },
  tick:function(time,dt){
    for(const p of this.pool){
      if(!p.alive && Math.random()<0.05){
        p.alive=true;p.t=0;
        p.obj.visible=true;
        p.obj.position.set((Math.random()-.5)*0.1,(Math.random()-.5)*0.1,-0.2);
      }else if(p.alive){
        p.t+=dt;p.obj.position.z-=dt*0.0003;p.obj.material.opacity=Math.max(0,1-p.t/3000);
        if(p.t>3000){p.alive=false;p.obj.visible=false;}
      }
    }
  }
});
document.getElementById('aeroEmitter').setAttribute('droplet-field','');

// Continue → Lungs
document.getElementById('continueBtn').onclick=()=>{window.location.href='lungs.html';};
</script>
</body>
</html>
