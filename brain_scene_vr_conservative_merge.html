<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vaporized â€” Brain Scene</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- REMOVED duplicate Three.js - A-Frame includes it already -->
  
  <style>
    html, body { margin:0; height:100%; background:#fff; font-family:system-ui,Segoe UI,Arial; overflow: hidden; }
    .whiteboard{
      position:fixed; left:12px; top:18px; width:420px; max-width:40vw; z-index:1200;
      background:#f8fbff; border:2px solid #dbe7ff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:14px 16px;
    }
    .whiteboard h2{ margin:0 0 10px 0; font-size:20px; color:#0f172a }
    .answers{ display:grid; gap:6px }
    .ans{ background:#ffffff; border:1px solid #d7e3ff; border-radius:10px; padding:10px 12px; color:#0b1a33; cursor: pointer; }
    .ans:hover { background: #f0f5ff; }
    .ans strong{ margin-right:6px }
    .ans.active{ border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.25) inset }
    .ans.done{ opacity:.85 }
    .callout-box{
      position:fixed; right:12px; top:18px; z-index:1100; width:360px; max-width:32vw;
      background:#111; color:#fff; border-radius:12px; border:1px solid #333; padding:14px 16px; display:none;
      box-shadow:0 8px 28px rgba(0,0,0,.25); text-align:left;
    }
    .callout-box h3{ margin:0 0 6px 0; font-size:18px }
    .callout-box p{ margin:0; line-height:1.35; color:#cfd8e3 }
    #leaderOverlay{ position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:1099; pointer-events:none; display:none; }
    .cta{position:fixed; left:50%; transform:translateX(-50%); bottom:28px; z-index:1200; display:none;}
    .cta button{background:#0f1220;color:#cfe8ff;border:1px solid #243159;border-radius:12px;padding:12px 18px;font-size:18px;cursor:pointer}
    .cta button:hover{background:#182242}
    #statusDot{ position:fixed; right:12px; bottom:12px; z-index:1200; width:10px; height:10px; border-radius:50%; background:#2aa54a; border:1px solid #511; }
    .fade-out{ animation:fade 0.9s forwards }
    @keyframes fade { to { opacity:0; transform:scale(.96) } }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .hidden {
      display: none !important;
    }
    
    /* Loading progress styles */
    .progress-bar {
      width: 300px;
      height: 4px;
      background: #333;
      border-radius: 2px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Ensure whiteboard is visible */
    #wb {
      display: block !important;
    }
  </style>
</head>
<body>

<div id="loading-screen">
  <h2>Loading Brain Scene</h2>
  <p>Please wait while we prepare your VR experience...</p>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <p id="loadingStatus">Initializing...</p>
</div>

<!-- WHITEBOARD - Made sure it's visible by default -->
<div class="whiteboard" id="wb" style="display: block;">
  <h2 id="wbQ">How does vaping affect the adolescent brain?</h2>
  <div class="answers">
    <div class="ans" id="wbA" onclick="playScene('A')"><strong>A.</strong> Poor concentration</div>
    <div class="ans" id="wbB" onclick="playScene('B')"><strong>B.</strong> Impaired learning & memory</div>
    <div class="ans" id="wbC" onclick="playScene('C')"><strong>C.</strong> Increased risk of addiction</div>
    <div class="ans" id="wbD" onclick="playScene('D')"><strong>D.</strong> Mood swings & anxiety</div>
  </div>
</div>

<div id="callout" class="callout-box">
  <h3 id="callTitle">Title</h3>
  <p id="callBody">Body text</p>
</div>

<svg id="leaderOverlay">
  <line id="leader" x1="0" y1="0" x2="0" y2="0" stroke="#000" stroke-width="2.5" stroke-linecap="round"/>
  <circle id="leaderDot" cx="0" cy="0" r="5" fill="#d91525" stroke="#600" stroke-width="1.5" />
</svg>

<div id="statusDot"></div>

<div class="cta" id="ctaBox"><button id="ctaBtn">Continue to Next Scene</button></div>

<!-- SIMPLIFIED A-FRAME SCENE with better error handling -->
<a-scene 
  renderer="antialias:true; colorManagement:true;" 
  background="color:#ffffff" 
  vr-mode-ui="enabled:true"
  loading-screen="enabled: true"
  stats>
  
  <!-- White background -->
  <a-sky color="#ffffff"></a-sky>

  <!-- Camera rig -->
  <a-entity id="rig" movement-controls position="0 1.6 0">
    <a-entity camera look-controls wasd-controls="enabled: false" position="0 0 0"></a-entity>
  </a-entity>

  <!-- Lighting -->
  <a-entity light="type: ambient; intensity: 0.8; color: #FFFFFF"></a-entity>
  <a-entity light="type: directional; intensity: 0.8; color: #FFFFFF; position: 2 5 3" cast-shadow></a-entity>

  <a-assets timeout="60000">
    <!-- Brain model with fallback -->
    <a-asset-item id="brainModel" src="assets/models/Brain.glb"></a-asset-item>
    
    <!-- Audio files -->
    <audio id="vo_A" src="assets/audio/vo/vo_A.mp3" preload="auto"></audio>
    <audio id="vo_B" src="assets/audio/vo/vo_B.mp3" preload="auto"></audio>
    <audio id="vo_C" src="assets/audio/vo/vo_C.mp3" preload="auto"></audio>
    <audio id="vo_D" src="assets/audio/vo/vo_D.mp3" preload="auto"></audio>
  </a-assets>

  <!-- Brain entity with event listeners -->
  <a-entity 
    id="brain" 
    gltf-model="#brainModel" 
    position="0 1.5 -3" 
    scale="1.5 1.5 1.5"
    animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear">
  </a-entity>

  <!-- Fallback placeholder in case model fails to load -->
  <a-entity id="brainPlaceholder" geometry="primitive: sphere; radius: 0.5" material="color: #6666FF" position="0 1.5 -3" scale="1 1 1" visible="false"></a-entity>

</a-scene>

<script>
// Debug logging
console.log("Brain Scene: Starting initialization");

// Enhanced scene data
const scenes = {
  A: {
    title: "Poor Concentration",
    body: "Nicotine disrupts neurotransmitter balance in the prefrontal cortex, making it harder to focus and maintain attention during complex tasks.",
    yaw: 0,
    pitch: 10,
    zoomZ: -2.0,
    dot: [0.3, 0.5, 0.2],
    duration: 5000
  },
  B: {
    title: "Impaired Learning & Memory", 
    body: "The hippocampus, crucial for memory formation, is particularly vulnerable to nicotine during adolescent development, leading to reduced learning capacity.",
    yaw: 45,
    pitch: 5,
    zoomZ: -2.2,
    dot: [0.1, 0.3, 0.4],
    duration: 5000
  },
  C: {
    title: "Increased Risk of Addiction",
    body: "Adolescent brains have more active reward centers. Nicotine triggers dopamine release, creating stronger addiction pathways that are harder to break.",
    yaw: -30,
    pitch: 8,
    zoomZ: -2.5,
    dot: [-0.2, 0.4, 0.3],
    duration: 5000
  },
  D: {
    title: "Mood Swings & Anxiety",
    body: "Nicotine withdrawal causes irritability and anxiety. The brain becomes dependent on nicotine to regulate mood, leading to emotional instability.",
    yaw: 180,
    pitch: -5,
    zoomZ: -2.3,
    dot: [-0.1, 0.6, -0.2],
    duration: 5000
  }
};

// Global variables
const sceneEl = document.querySelector('a-scene');
const brain = document.getElementById('brain');
const brainPlaceholder = document.getElementById('brainPlaceholder');
const loadingScreen = document.getElementById('loading-screen');
const progressFill = document.getElementById('progressFill');
const loadingStatus = document.getElementById('loadingStatus');
const call = document.getElementById('callout');
const title = document.getElementById('callTitle');
const body = document.getElementById('callBody');
const ctaBox = document.getElementById('ctaBox');
const ctaBtn = document.getElementById('ctaBtn');
const whiteboard = document.getElementById('wb');

let yaw = 0, pitch = 0, zoomZ = -3;
const Z_MIN = -5.0, Z_MAX = -1.0;
let currentAudio = null;
let isAutoSequenceRunning = false;
let brainLoaded = false;

// Enhanced loading system
function updateLoadingProgress(percent, status) {
  console.log(`Loading: ${percent}% - ${status}`);
  progressFill.style.width = percent + '%';
  loadingStatus.textContent = status;
}

// Initialize the scene
function initializeScene() {
  console.log("Initializing brain scene...");
  
  // Make sure whiteboard is visible
  whiteboard.style.display = 'block';
  
  // Set up brain model loading handlers
  brain.addEventListener('model-loaded', function() {
    console.log('Brain model loaded successfully!');
    brainLoaded = true;
    updateLoadingProgress(100, 'Brain model loaded!');
    completeLoading();
  });

  brain.addEventListener('model-error', function(evt) {
    console.error('Brain model failed to load:', evt.detail);
    updateLoadingProgress(100, 'Using fallback model');
    
    // Show placeholder instead
    brain.setAttribute('visible', 'false');
    brainPlaceholder.setAttribute('visible', 'true');
    brainLoaded = true;
    completeLoading();
  });

  // Start checking for assets
  checkAssetsLoaded();
}

function checkAssetsLoaded() {
  updateLoadingProgress(30, 'Loading 3D model...');
  
  // Check if A-Frame is ready
  if (sceneEl.hasLoaded) {
    updateLoadingProgress(50, 'A-Frame scene ready');
  } else {
    sceneEl.addEventListener('loaded', function() {
      updateLoadingProgress(50, 'A-Frame scene ready');
    });
  }

  // Check audio files
  let audioLoaded = 0;
  const totalAudio = 4;
  
  ['A', 'B', 'C', 'D'].forEach(sceneId => {
    const audio = document.getElementById(`vo_${sceneId}`);
    if (audio) {
      audio.addEventListener('canplaythrough', () => {
        audioLoaded++;
        updateLoadingProgress(50 + (audioLoaded / totalAudio * 30), `Audio loaded: ${audioLoaded}/${totalAudio}`);
      });
      
      audio.addEventListener('error', () => {
        console.warn(`Audio vo_${sceneId} failed to load`);
        audioLoaded++;
        updateLoadingProgress(50 + (audioLoaded / totalAudio * 30), `Audio loaded: ${audioLoaded}/${totalAudio}`);
      });
    }
  });
}

function completeLoading() {
  console.log("Scene loading complete!");
  
  setTimeout(() => {
    loadingScreen.classList.add('hidden');
    whiteboard.style.display = 'block'; // Ensure whiteboard is visible
    
    // Initialize controls
    initializeBrainControls();
    
    // Start auto sequence after a brief delay
    setTimeout(() => {
      startAutoSequence();
    }, 1500);
  }, 1000);
}

function initializeBrainControls() {
  console.log("Initializing brain controls");
  applyBrainTransform();
  
  // Keyboard controls
  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft'){ yaw -= 8; applyBrainTransform(); }
    if(e.key === 'ArrowRight'){ yaw += 8; applyBrainTransform(); }
    if(e.key === 'ArrowUp'){ pitch -= 8; applyBrainTransform(); }
    if(e.key === 'ArrowDown'){ pitch += 8; applyBrainTransform(); }
    
    const map = { '1':'A', '2':'B', '3':'C', '4':'D' };
    if(e.key in map){ 
      playScene(map[e.key]); 
    }
  });

  // Zoom controls
  window.addEventListener('wheel', (e) => {
    const dz = e.deltaY > 0 ? -0.3 : 0.3;
    zoomZ = Math.max(Z_MIN, Math.min(Z_MAX, zoomZ + dz));
    applyBrainTransform();
  }, { passive: true });
}

function applyBrainTransform() {
  if (brain.object3D) {
    brain.object3D.rotation.set(
      THREE.MathUtils.degToRad(pitch),
      THREE.MathUtils.degToRad(yaw), 
      0
    );
    brain.object3D.position.set(0, 1.5, zoomZ);
  }
  
  // Also apply to placeholder if active
  if (brainPlaceholder.object3D && brainPlaceholder.getAttribute('visible') === 'true') {
    brainPlaceholder.object3D.rotation.set(
      THREE.MathUtils.degToRad(pitch),
      THREE.MathUtils.degToRad(yaw), 
      0
    );
    brainPlaceholder.object3D.position.set(0, 1.5, zoomZ);
  }
}

function setActiveWB(id) {
  const answers = ['wbA', 'wbB', 'wbC', 'wbD'];
  answers.forEach(ansId => {
    const el = document.getElementById(ansId);
    if (el) {
      el.classList.remove('active', 'done');
    }
  });
  
  if (id === 'A' && document.getElementById('wbA')) {
    document.getElementById('wbA').classList.add('active');
  }
  if (id === 'B' && document.getElementById('wbB')) {
    document.getElementById('wbA').classList.add('done');
    document.getElementById('wbB').classList.add('active');
  }
  if (id === 'C' && document.getElementById('wbC')) {
    document.getElementById('wbA').classList.add('done');
    document.getElementById('wbB').classList.add('done');
    document.getElementById('wbC').classList.add('active');
  }
  if (id === 'D' && document.getElementById('wbD')) {
    document.getElementById('wbA').classList.add('done');
    document.getElementById('wbB').classList.add('done');
    document.getElementById('wbC').classList.add('done');
    document.getElementById('wbD').classList.add('active');
  }
}

function playScene(id) {
  if (!scenes[id]) {
    console.error(`Scene ${id} not found`);
    return;
  }
  
  console.log(`Playing scene: ${id}`);
  const scene = scenes[id];
  
  // Stop any current audio
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
  }
  
  // Update brain position/rotation
  yaw = scene.yaw;
  pitch = scene.pitch;
  zoomZ = scene.zoomZ;
  applyBrainTransform();
  
  // Update callout
  title.textContent = scene.title;
  body.textContent = scene.body;
  call.style.display = 'block';
  
  // Update whiteboard
  setActiveWB(id);
  
  // Play audio
  const audioElement = document.getElementById(`vo_${id}`);
  if (audioElement) {
    currentAudio = audioElement;
    audioElement.play().catch(e => {
      console.log('Audio play failed, continuing silently:', e);
    });
  }
  
  // Show CTA after scene D
  if (id === 'D') {
    setTimeout(() => {
      ctaBox.style.display = 'block';
    }, 3000);
  }
}

function startAutoSequence() {
  console.log("Starting auto sequence");
  isAutoSequenceRunning = true;
  
  // Play scenes in sequence with proper timing
  playScene('A');
  setTimeout(() => {
    if (isAutoSequenceRunning) playScene('B');
  }, scenes.A.duration + 1000);
  
  setTimeout(() => {
    if (isAutoSequenceRunning) playScene('C');
  }, scenes.A.duration + scenes.B.duration + 2000);
  
  setTimeout(() => {
    if (isAutoSequenceRunning) playScene('D');
  }, scenes.A.duration + scenes.B.duration + scenes.C.duration + 3000);
}

// CTA button handler
ctaBtn.addEventListener('click', () => {
  isAutoSequenceRunning = false;
  if (currentAudio) {
    currentAudio.pause();
  }
  document.body.classList.add('fade-out');
  setTimeout(() => {
    window.location.href = "Part1.html";
  }, 900);
});

// Start initialization when page loads
window.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, initializing scene...");
  updateLoadingProgress(10, 'Starting VR scene...');
  initializeScene();
});

// Fallback timeout for loading screen
setTimeout(() => {
  if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
    console.warn('Forcing loading screen hide after timeout');
    loadingScreen.classList.add('hidden');
    whiteboard.style.display = 'block';
    completeLoading();
  }
}, 15000);

// Error handling
window.addEventListener('error', function(e) {
  console.error('Global error:', e.error);
  console.error('File:', e.filename);
  console.error('Line:', e.lineno);
});
</script>
</body>
</html>